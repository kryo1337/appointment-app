services:
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: appointment-azurite
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    volumes:
      - azurite-data:/data
    networks:
      - appointment-network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 10002 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: appointment-backend
    ports:
      - "7071:80"
    environment:
      - AzureWebJobsStorage=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;
      - FUNCTIONS_WORKER_RUNTIME=python
    volumes:
      - ./backend:/home/site/wwwroot
    depends_on:
      azurite:
        condition: service_started
    networks:
      - appointment-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: appointment-frontend
    ports:
      - "3000:5173"
    environment:
      - VITE_API_URL=http://localhost:7071/api
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - appointment-network
    command: npm run dev -- --host 0.0.0.0 --port 5173

networks:
  appointment-network:
    driver: bridge

volumes:
  azurite-data:

